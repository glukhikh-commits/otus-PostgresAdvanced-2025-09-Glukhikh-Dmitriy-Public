### 1. Создание виртуальной частной сети.
```
yc vpc network create --name otus-net --description "otus-net"
```
### 2. Создание подсети в этой сети для размещения виртуальных машин.
```
yc vpc subnet create --name otus-subnet --range 192.168.0.0/24 --network-name otus-net --description "otus-subnet"
```
### 3.  Создание 7 виртуальных машин: etcd-1 etcd-2 etcd-3 pg-1 pg-2 pg-3 haproxy
```
for i in 1 2 3; do
  yc compute instance create etcd-$i \
    --hostname etcd-$i \
    --zone ru-central1-b \
    --cores 2 \
    --memory 2 \
    --create-boot-disk size=15G,type=network-hdd,image-folder-id=standard-images,image-family=ubuntu-2404-lts \
    --network-interface subnet-name=otus-subnet,nat-ip-version=ipv4 \
    --ssh-key ~/.ssh/yc_key.pub
done
```
```
for i in 1 2 3; do
  yc compute instance create pg-$i \
    --hostname pg-$i \
    --zone ru-central1-b \
    --cores 2 \
    --memory 2 \
    --create-boot-disk size=15G,type=network-hdd,image-folder-id=standard-images,image-family=ubuntu-2404-lts \
    --network-interface subnet-name=otus-subnet,nat-ip-version=ipv4 \
    --ssh-key ~/.ssh/yc_key.pub
done
```
```
yc compute instance create haproxy \
  --hostname haproxy \
  --zone ru-central1-b \
  --cores 2 \
  --memory 2 \
  --create-boot-disk size=20G,type=network-hdd,image-folder-id=standard-images,image-family=ubuntu-2404-lts \
  --network-interface subnet-name=otus-subnet,nat-ip-version=ipv4 \
  --ssh-key ~/.ssh/yc_key.pub
```
### 4. Подключение к VM через ssh ключ
```
ssh -i ~/.ssh/yc_key yc-user@158.160.67.6
ssh -i ~/.ssh/yc_key yc-user@84.201.137.247
ssh -i ~/.ssh/yc_key yc-user@84.252.136.97

ssh -i ~/.ssh/yc_key yc-user@158.160.30.176
ssh -i ~/.ssh/yc_key yc-user@158.160.75.99
ssh -i ~/.ssh/yc_key yc-user@158.160.14.189

ssh -i ~/.ssh/yc_key yc-user@158.160.23.83
```
### 5. Установка бинарников etcd
```
sudo apt update
cd /tmp
wget https://github.com/etcd-io/etcd/releases/download/v3.5.13/etcd-v3.5.13-linux-amd64.tar.gz
```
```
tar -xzf etcd-v3.5.13-linux-amd64.tar.gz
cd etcd-v3.5.13-linux-amd64
```
```
sudo mv etcd etcdctl /usr/local/bin/
sudo chmod +x /usr/local/bin/etcd /usr/local/bin/etcdctl
```
```
etcd --version
etcd Version: 3.5.13
Git SHA: c9063a0dc
Go Version: go1.21.8
Go OS/Arch: linux/amd64
```
```
etcdctl version
etcdctl version: 3.5.13
API version: 3.5
```
### 6. Настройка etcd на примере etcd-1
```
sudo nano /etc/default/etcd
```
```                              
ETCD_NAME="etcd-1"

ETCD_DATA_DIR="/var/lib/etcd"

ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"

ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.0.29:2380"
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.0.29:2379"

ETCD_INITIAL_CLUSTER_TOKEN="etcd_pg_cluster"
ETCD_INITIAL_CLUSTER="etcd-1=http://192.168.0.29:2380,etcd-2=http://192.168.0.22:2380,etcd-3=http://192.168.0.5:2380"
ETCD_INITIAL_CLUSTER_STATE="new"
```
```
sudo nano /etc/systemd/system/etcd.service
```
```
[Unit]
Description=etcd key-value store
After=network.target

[Service]
User=etcd
Type=simple
EnvironmentFile=/etc/default/etcd
ExecStart=/usr/local/bin/etcd
Restart=always
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```
```
sudo systemctl daemon-reload
sudo systemctl enable etcd
sudo systemctl start etcd
```
```
systemctl status etcd
```
```
etcd.service - etcd key-value store
     Loaded: loaded (/etc/systemd/system/etcd.service; enabled; preset: enabled)
     Active: active (running) since Wed 2026-02-18 08:09:57 UTC; 6s ago
   Main PID: 1231 (etcd)
      Tasks: 5 (limit: 4653)
     Memory: 28.0M (peak: 28.3M)
        CPU: 152ms
     CGroup: /system.slice/etcd.service
             └─1231 /usr/local/bin/etcd
```
### 7. Установка patroni и postgres
```
sudo apt update
apt -y install python python3-pip python3-dev python3-psycopg2 libpq-dev
pip3 install setuptools --break-system-packages
pip3 install psycopg2 --break-system-packages
pip3 install psycopg2-binary --break-system-packages
pip3 install patroni --break-system-packages
pip3 install python-etcd --break-system-packages 
```
```
sudo apt -y install postgresql
```
### 8. Остановка postgres и подготовка data directory
```
sudo systemctl stop postgresql
sudo systemctl disable postgresql
```
```
sudo rm -rf /var/lib/postgresql/16/main/*
sudo chown -R postgres:postgres /var/lib/postgresql/16
```
### 9. Настройка patroni.yml и patroni.service
```
sudo nano /etc/patroni.yml
```
```
scope: pg-ha
namespace: /db/
name: pg-1

restapi:
  listen: 192.168.0.9:8008
  connect_address: 192.168.0.9:8008

etcd3:
  hosts: 192.168.0.29:2379,192.168.0.22:2379,192.168.0.5:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576

  initdb:
    - encoding: UTF8
    - data-checksums

  pg_hba:
    - host replication replicator 192.168.0.0/24 scram-sha-256
    - host all all 0.0.0.0/0 scram-sha-256

  users:
    admin:
      password: admin_pass
      options:
        - createrole
        - createdb

postgresql:
  listen: 127.0.0.1,192.168.0.9:5432
  connect_address: 192.168.0.9:5432
  data_dir: /var/lib/postgresql/16/main
  bin_dir: /usr/lib/postgresql/16/bin

  authentication:
    replication:
      username: replicator
      password: repl_pass
    superuser:
      username: postgres
      password: postgres_pass
    rewind:
      username: rewind_user
      password: rewind_pass

  parameters:
    wal_level: replica
    hot_standby: "on"
    unix_socket_directories: '.'

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
``` 
```
sudo nano /etc/systemd/system/patroni.service
```
```
[Unit]
Description=Patroni PostgreSQL
After=network.target

[Service]
Type=simple
User=postgres
Group=postgres
WorkingDirectory=/
ExecStart=/usr/local/bin/patroni /etc/patroni.yml
Restart=on-failure
RestartSec=5
LimitNOFILE=10240

[Install]
WantedBy=multi-user.target
```
### 10. Запуск patroni
```
sudo systemctl daemon-reload
sudo systemctl start patroni
```
```
sudo journalctl -u patroni -f
```
```
Feb 17 16:28:32 pg-2 patroni[6085]: 2026-02-17 16:28:32.313 UTC [6085] LOG:  completed backup recovery with redo LSN 0/2000028 and end LSN 0/2000100
Feb 17 16:28:32 pg-2 patroni[6085]: 2026-02-17 16:28:32.313 UTC [6085] LOG:  consistent recovery state reached at 0/2000100
Feb 17 16:28:32 pg-2 patroni[6081]: 2026-02-17 16:28:32.313 UTC [6081] LOG:  database system is ready to accept read-only connections
Feb 17 16:28:32 pg-2 patroni[6086]: 2026-02-17 16:28:32.333 UTC [6086] LOG:  started streaming WAL from primary at 0/3000000 on timeline 1
Feb 17 16:28:33 pg-2 patroni[6087]: localhost:5432 - accepting connections
Feb 17 16:28:33 pg-2 patroni[6089]: localhost:5432 - accepting connections
Feb 17 16:28:33 pg-2 patroni[6068]: 2026-02-17 16:28:33,247 INFO: Lock owner: pg-1; I am pg-2
Feb 17 16:28:33 pg-2 patroni[6068]: 2026-02-17 16:28:33,247 INFO: establishing a new patroni heartbeat connection to postgres
Feb 17 16:28:33 pg-2 patroni[6068]: 2026-02-17 16:28:33,409 INFO: no action. I am (pg-2), a secondary, and following a leader (pg-1)
Feb 17 16:28:37 pg-2 patroni[6068]: 2026-02-17 16:28:37,836 INFO: no action. I am (pg-2), a secondary, and following a leader (pg-1)
Feb 17 16:28:48 pg-2 patroni[6068]: 2026-02-17 16:28:48,327 INFO: no action. I am (pg-2), a secondary, and following a leader (pg-1)
```
```
patronictl -c /etc/patroni.yml list
+ Cluster: pg-ha (7607866931124827535) -------+----+-------------+-----+------------+-----+
| Member | Host         | Role    | State     | TL | Receive LSN | Lag | Replay LSN | Lag |
+--------+--------------+---------+-----------+----+-------------+-----+------------+-----+
| pg-1   | 192.168.0.18 | Leader  | running   |  1 |             |     |            |     |
| pg-2   | 192.168.0.22 | Replica | streaming |  1 |   0/5000060 |   0 |  0/5000060 |   0 |
| pg-3   | 192.168.0.26 | Replica | streaming |  1 |   0/5000060 |   0 |  0/5000060 |   0 |
+--------+--------------+---------+-----------+----+-------------+-----+------------+-----+
```
### 11. Редактирование конфигурационного файла
```
sudo apt update
sudo apt install -y haproxy
haproxy -v
```
```
sudo nano /etc/haproxy/haproxy.cfg
```
```
global
    log /dev/log local0
    log /dev/log local1 notice
    daemon
    maxconn 2000

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5s
    timeout client  1m
    timeout server  1m

frontend postgres_rw
    bind *:5432
    default_backend postgres_leader

backend postgres_leader
    option httpchk GET /primary
    http-check expect status 200

    server pg-1 192.168.0.18:5432 check port 8008
    server pg-2 192.168.0.22:5432 check port 8008
    server pg-3 192.168.0.26:5432 check port 8008

frontend postgres_ro
    bind *:5433
    default_backend postgres_replicas

backend postgres_replicas
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200

    server pg-2 192.168.0.22:5432 check port 8008
    server pg-3 192.168.0.26:5432 check port 8008
```
```
sudo systemctl enable haproxy
sudo systemctl restart haproxy
sudo systemctl status haproxy
```
```
Synchronizing state of haproxy.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.
Executing: /usr/lib/systemd/systemd-sysv-install enable haproxy
● haproxy.service - HAProxy Load Balancer
     Loaded: loaded (/usr/lib/systemd/system/haproxy.service; enabled; preset: enabled)
     Active: active (running) since Tue 2026-02-17 16:48:20 UTC; 38ms ago
       Docs: man:haproxy(1)
             file:/usr/share/doc/haproxy/configuration.txt.gz
   Main PID: 2473 (haproxy)
     Status: "Ready."
      Tasks: 3 (limit: 2315)
     Memory: 39.5M (peak: 40.0M)
        CPU: 186ms
     CGroup: /system.slice/haproxy.service
             ├─2473 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid >
             └─2478 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid >

Feb 17 16:48:20 haproxy systemd[1]: Starting haproxy.service - HAProxy Load Balancer...
Feb 17 16:48:20 haproxy haproxy[2473]: [NOTICE]   (2473) : New worker (2478) forked
Feb 17 16:48:20 haproxy systemd[1]: Started haproxy.service - HAProxy Load Balancer.
Feb 17 16:48:20 haproxy haproxy[2473]: [NOTICE]   (2473) : Loading success.
```
### 12. Проверка на отказоустойчивость кластера на примере pg-1
```
sudo systemctl stop patroni
yc-user@pg-1:~$ patronictl -c /etc/patroni.yml list
+ Cluster: pg-ha (7607866931124827535) -----+----+-------------+-----+------------+-----+
| Member | Host         | Role    | State   | TL | Receive LSN | Lag | Replay LSN | Lag |
+--------+--------------+---------+---------+----+-------------+-----+------------+-----+
| pg-1   | 192.168.0.18 | Replica | stopped |    |     unknown |     |    unknown |     |
| pg-2   | 192.168.0.22 | Leader  | running |  2 |             |     |            |     |
| pg-3   | 192.168.0.26 | Replica | running |  1 |   0/5000148 |   0 |  0/5000148 |   0 |
+--------+--------------+---------+---------+----+-------------+-----+------------+-----+
```
```
yc-user@pg-1:~$ patronictl -c /etc/patroni.yml list
+ Cluster: pg-ha (7607866931124827535) -----+----+-------------+-----+------------+-----+
| Member | Host         | Role    | State   | TL | Receive LSN | Lag | Replay LSN | Lag |
+--------+--------------+---------+---------+----+-------------+-----+------------+-----+
| pg-2   | 192.168.0.22 | Leader  | running |  2 |             |     |            |     |
| pg-3   | 192.168.0.26 | Replica | running |  1 |   0/5000148 |   0 |  0/5000148 |   0 |
+--------+--------------+---------+---------+----+-------------+-----+------------+-----+
```
```
sudo systemctl start patroni
yc-user@pg-1:~$ patronictl -c /etc/patroni.yml list
+ Cluster: pg-ha (7607866931124827535) -----+----+-------------+-----+------------+-----+
| Member | Host         | Role    | State   | TL | Receive LSN | Lag | Replay LSN | Lag |
+--------+--------------+---------+---------+----+-------------+-----+------------+-----+
| pg-1   | 192.168.0.18 | Replica | running |  1 |   0/5000000 |   0 |  0/50001C0 |   0 |
| pg-2   | 192.168.0.22 | Leader  | running |  2 |             |     |            |     |
| pg-3   | 192.168.0.26 | Replica | running |  1 |   0/5000148 |   0 |  0/5000148 |   0 |
+--------+--------------+---------+---------+----+-------------+-----+------------+-----+
```