### 1. Создание виртуальной частной сети и подсети
```
yc vpc network create --name otus-net --description "otus-net"
```
```
yc vpc subnet create --name otus-subnet --range 192.168.0.0/24 --network-name otus-net --description "otus-subnet"
```
### 2. Создание otus-vm
```
yc compute instance create otus-vm \
    --hostname otus-vm \
    --zone ru-central1-b \
    --platform standard-v3 \
    --cores 2 \
    --memory 2 \
    --create-boot-disk size=15G,type=network-hdd,image-folder-id=standard-images,image-family=ubuntu-2404-lts \
    --network-interface subnet-name=otus-subnet,nat-ip-version=ipv4 \
    --ssh-key ~/.ssh/yc_key.pub
```
```
ssh -i ~/.ssh/yc_key yc-user@158.160.74.200
```
### 3. Установка PostgreSQL 16
```
sudo apt update
```
```
sudo apt -y install postgresql
```
```
psql --version
```
```
psql (PostgreSQL) 16.11 (Ubuntu 16.11-0ubuntu0.24.04.1)
```
### 4. Установка и настройка WAL-G
```
wget https://github.com/wal-g/wal-g/releases/download/v3.0.8/wal-g-pg-22.04-amd64.tar.gz
tar -xzf wal-g-pg-22.04-amd64.tar.gz
sudo mv wal-g-pg-22.04-amd64 /usr/local/bin/wal-g
sudo chmod +x /usr/local/bin/wal-g
```
```
wal-g --version
wal-g version v3.0.8    f81943e 2026.01.21_14:31:34     PostgreSQL
```
```
ldd /usr/local/bin/wal-g || true
```
```
linux-vdso.so.1 (0x00007fff449ac000)
libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007df0c3100000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007df0c2e00000)
/lib64/ld-linux-x86-64.so.2 (0x00007df0c31f1000)
```
```
sudo mkdir /home/backups 
sudo chown -R postgres:postgres /home/backups/
```
```
sudo su postgres
nano ~/.walg.json
```
```
{
    "WALG_FILE_PREFIX": "/home/backups",
    "WALG_COMPRESSION_METHOD": "brotli",
    "WALG_DELTA_MAX_STEPS": "5",
    "WALG_UPLOAD_DISK_CONCURRENCY": "4",
    "PGDATA": "/var/lib/postgresql/18/main",
    "PGHOST": "localhost"
}
```
### 5. Редактирование postgresql.auto.conf и pg_hba.conf
```
mkdir /var/lib/postgresql/log
```
```
sudo nano /var/lib/postgresql/16/main/postgresql.auto.conf
```
```
# WAL settings
wal_level = replica
archive_mode = on
archive_timeout = 60

archive_command = 'wal-g wal-push \"%p\" >> /var/log/postgresql/archive_command.log 2>&1'
restore_command = 'wal-g wal-fetch \"%f\" \"%p\" >> /var/log/postgresql/restore_command.log 2>&1'
```
```
sudo nano /etc/postgresql/16/main/pg_hba.conf
```
```
host all all 127.0.0.1/32 trust
```
```
sudo systemctl restart postgresql
sudo systemctl status postgresql
```
```
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; preset: enabled)
     Active: active (exited) since Thu 2026-02-26 07:39:52 UTC; 2s ago
    Process: 3767 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 3767 (code=exited, status=0/SUCCESS)
        CPU: 1ms
```
### 6. Создание таблицы
```
sudo -u postgres psql
```
```
CREATE TABLE test(i int);
INSERT INTO test VALUES (10), (20), (30);
```
```
SELECT * FROM test;
```
```
 i  
----
 10
 20
 30
(3 rows)
```
### 7. Первый бэкап
```
sudo su - postgres
``` 
```
wal-g --config=/var/lib/postgresql/.walg.json backup-push /var/lib/postgresql/16/main
```
```
INFO: 2026/02/26 07:44:50.557255 Backup will be pushed to storage: default
INFO: 2026/02/26 07:44:50.565079 Couldn't find previous backup. Doing full backup.
INFO: 2026/02/26 07:44:50.571705 Calling pg_start_backup()
INFO: 2026/02/26 07:44:50.735194 Initializing the PG alive checker (interval=1m0s)...
INFO: 2026/02/26 07:44:50.735780 Starting a new tar bundle
INFO: 2026/02/26 07:44:50.735828 Walking ...
INFO: 2026/02/26 07:44:50.736061 Starting part 1 ...
INFO: 2026/02/26 07:44:50.736158 Starting part 2 ...
INFO: 2026/02/26 07:44:50.736506 Starting part 3 ...
INFO: 2026/02/26 07:44:50.736790 Starting part 4 ...
INFO: 2026/02/26 07:44:50.898113 Packing ...
INFO: 2026/02/26 07:44:50.902403 Finished writing part 1.
INFO: 2026/02/26 07:44:50.903129 Finished writing part 3.
INFO: 2026/02/26 07:44:50.903944 Finished writing part 4.
INFO: 2026/02/26 07:44:50.904965 Finished writing part 2.
INFO: 2026/02/26 07:44:50.904994 Starting part 5 ...
INFO: 2026/02/26 07:44:50.905030 /global/pg_control
INFO: 2026/02/26 07:44:50.905305 Finished writing part 5.
INFO: 2026/02/26 07:44:50.905322 Calling pg_stop_backup()
INFO: 2026/02/26 07:44:51.015576 Starting part 6 ...
INFO: 2026/02/26 07:44:51.015866 backup_label
INFO: 2026/02/26 07:44:51.016032 tablespace_map
INFO: 2026/02/26 07:44:51.016488 Finished writing part 6.
INFO: 2026/02/26 07:44:51.017070 Querying pg_database
INFO: 2026/02/26 07:44:51.057905 Wrote backup with name base_000000010000000000000002 to storage default
```
```
wal-g --config=/var/lib/postgresql/.walg.json backup-list
```
```
INFO: 2026/02/26 07:46:26.282875 List backups from storages: [default]
backup_name                   modified             wal_file_name            storage_name
base_000000010000000000000002 2026-02-26T07:44:51Z 000000010000000000000002 default
```
### 8. Добавление новых данных и второй бэкап
```
sudo -u postgres psql
```
```
insert into test values (110), (120), (130);
select * from test;
```
```
  i  
-----
  10
  20
  30
 110
 120
 130
(6 rows)
```
```
sudo su - postgres
wal-g backup-push /var/lib/postgresql/16/main
```
```
INFO: 2026/02/26 07:54:21.161167 Backup will be pushed to storage: default
INFO: 2026/02/26 07:54:21.168631 LATEST backup is: 'base_000000010000000000000005_D_000000010000000000000002'
INFO: 2026/02/26 07:54:21.168933 Delta backup from base_000000010000000000000005_D_000000010000000000000002 with LSN 0/5000028.
INFO: 2026/02/26 07:54:21.177651 Calling pg_start_backup()
INFO: 2026/02/26 07:54:21.264437 Initializing the PG alive checker (interval=1m0s)...
INFO: 2026/02/26 07:54:21.265584 Delta backup enabled
INFO: 2026/02/26 07:54:21.265618 Starting a new tar bundle
INFO: 2026/02/26 07:54:21.268052 Walking ...
INFO: 2026/02/26 07:54:21.268204 Starting part 1 ...
INFO: 2026/02/26 07:54:21.268304 Starting part 2 ...
INFO: 2026/02/26 07:54:21.268546 Starting part 3 ...
INFO: 2026/02/26 07:54:21.270670 Starting part 4 ...
INFO: 2026/02/26 07:54:21.276979 Packing ...
INFO: 2026/02/26 07:54:21.277325 Finished writing part 4.
INFO: 2026/02/26 07:54:21.277776 Finished writing part 1.
INFO: 2026/02/26 07:54:21.277930 Finished writing part 2.
INFO: 2026/02/26 07:54:21.278217 Finished writing part 3.
INFO: 2026/02/26 07:54:21.278235 Starting part 5 ...
INFO: 2026/02/26 07:54:21.278249 /global/pg_control
INFO: 2026/02/26 07:54:21.280061 Finished writing part 5.
INFO: 2026/02/26 07:54:21.280072 Calling pg_stop_backup()
INFO: 2026/02/26 07:54:21.340038 Starting part 6 ...
INFO: 2026/02/26 07:54:21.340103 backup_label
INFO: 2026/02/26 07:54:21.340117 tablespace_map
INFO: 2026/02/26 07:54:21.340399 Finished writing part 6.
INFO: 2026/02/26 07:54:21.340908 Querying pg_database
INFO: 2026/02/26 07:54:21.375000 Wrote backup with name base_000000010000000000000007_D_000000010000000000000005 to storage default
```
```
wal-g backup-list
```
```
INFO: 2026/02/26 07:55:31.255106 List backups from storages: [default]
backup_name                                              modified             wal_file_name            storage_name
base_000000010000000000000002                            2026-02-26T07:44:51Z 000000010000000000000002 default
base_000000010000000000000005_D_000000010000000000000002 2026-02-26T07:53:50Z 000000010000000000000005 default
base_000000010000000000000007_D_000000010000000000000005 2026-02-26T07:54:21Z 000000010000000000000007 default
```
### 9. Восстановление базы через создание нового кластера
```
sudo pg_createcluster -d /var/lib/postgresql/16/main2 16 main2
```
```
sudo su - postgres
``` 
```
rm -rf /var/lib/postgresql/16/main2/*
wal-g backup-fetch /var/lib/postgresql/16/main2 LATEST
```
```
INFO: 2026/02/26 08:45:43.985585 Selecting the latest backup...
INFO: 2026/02/26 08:45:43.985679 Backup to fetch will be searched in storages: [default]
INFO: 2026/02/26 08:45:43.985784 LATEST backup is: 'base_000000010000000000000007_D_000000010000000000000005'
INFO: 2026/02/26 08:45:43.988252 Delta from base_000000010000000000000005_D_000000010000000000000002 at LSN 0/5000028 
INFO: 2026/02/26 08:45:43.990571 Delta from base_000000010000000000000002 at LSN 0/2000028 
INFO: 2026/02/26 08:45:47.640335 Finished extraction of part_003.tar.br
INFO: 2026/02/26 08:45:48.585296 Finished extraction of part_004.tar.br
INFO: 2026/02/26 08:45:48.698576 Finished extraction of part_002.tar.br
INFO: 2026/02/26 08:45:48.915729 Finished extraction of part_001.tar.br
INFO: 2026/02/26 08:45:48.916301 Finished extraction of backup_label.tar.br
INFO: 2026/02/26 08:45:48.916326 Finished extraction of pg_control.tar.br
INFO: 2026/02/26 08:45:48.916341 
Backup extraction complete.
INFO: 2026/02/26 08:45:48.916350 base_000000010000000000000002 fetched. Upgrading from LSN 0/2000028 to LSN 0/5000028 
INFO: 2026/02/26 08:45:48.919421 Finished extraction of part_004.tar.br
INFO: 2026/02/26 08:45:48.919636 Finished extraction of part_003.tar.br
INFO: 2026/02/26 08:45:48.932798 Finished extraction of part_002.tar.br
INFO: 2026/02/26 08:45:48.943971 Finished extraction of part_001.tar.br
INFO: 2026/02/26 08:45:48.944195 Finished extraction of backup_label.tar.br
INFO: 2026/02/26 08:45:48.944200 Finished extraction of pg_control.tar.br
INFO: 2026/02/26 08:45:48.944247 
Backup extraction complete.
INFO: 2026/02/26 08:45:48.944256 base_000000010000000000000005_D_000000010000000000000002 fetched. Upgrading from LSN 0/5000028 to LSN 0/7000028 
INFO: 2026/02/26 08:45:48.948548 Finished extraction of part_004.tar.br
INFO: 2026/02/26 08:45:48.948619 Finished extraction of part_002.tar.br
INFO: 2026/02/26 08:45:48.948753 Finished extraction of part_001.tar.br
INFO: 2026/02/26 08:45:48.986314 Finished extraction of part_003.tar.br
INFO: 2026/02/26 08:45:48.991065 Finished extraction of pg_control.tar.br
INFO: 2026/02/26 08:45:49.002892 Finished extraction of backup_label.tar.br
INFO: 2026/02/26 08:45:49.002919 
Backup extraction complete.
```
```
touch /var/lib/postgresql/16/main2/recovery.signal
pg_ctlcluster 16 main2 start
```
### 10. Проверка данных
```
sudo -u postgres psql -p 5433
```
```
postgres=# \dt
```
```
        List of relations
 Schema | Name | Type  |  Owner   
--------+------+-------+----------
 public | test | table | postgres
(1 row)
```
```
select * from test;
```
```
  i  
-----
  10
  20
  30
 110
 120
 130
(6 rows)
```